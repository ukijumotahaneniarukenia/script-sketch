#!/usr/bin/env bash

usage(){
cat <<EOS
Usage:
   IN: $0 10 sleep 0.5
  OUT:
0:00:05 [==============================================================================================================================================================================>] 100%

   or

   IN: $0 30 bash 00027-bash-ある程度時間がかかる処理.sh
  OUT:
0:00:08 [==============================================================================================================================================================================>] 100%

   or

   IN: $0 15 bash 00027-bash-ある程度時間がかかる処理.sh
  OUT:
0:00:04 [==============================================================================================================================================================================>] 100%

   IN: $0 15 ./00027-bash-ある程度時間がかかる処理.sh
  OUT:
0:00:04 [==============================================================================================================================================================================>] 100%

EOS

exit 0

}

main(){
  ARGS=($(cat -));

  CNT=${ARGS[0]} #処理件数、総件数をコマンド引数に与える
  CMD=${ARGS[@]:1} #実行コマンドないしはスクリプト

  if [ -z "$CNT" ] ;then

    usage

  fi

  if [ -z "$CMD" ] ;then

    usage

  fi

  for x in $(eval echo {1..$CNT}) ; do
    eval "$CMD";
    printf .; #1バイトの某かの文字
  done | pv -pt -i0.01 -s$CNT -w$(tput cols) -H$(tput lines) 1>/dev/null

}

[ -p /dev/stdin ] && usage
[ -p /dev/stdin ] || echo -ne "$@" | main
