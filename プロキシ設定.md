- https://qiita.com/uzresk/items/bc7c4a9dc764390cd5ce

# プロキシの設定単位

  - プログラム単位
  - コマンドライン引数
  - ユーザー環境変数
  - システム環境変数

# rootユーザーパスワード設定

```bash
sudo passwd root
```

```bash
su root
```

```bash
sudo perl -p -i.bak -e 's%https?://(?!security)[^ \t]+%http://jp.archive.ubuntu.com/ubuntu/%g' /etc/apt/sources.list
```

# プロキシ設定一括スクリプト

windowsホストの環境変数に設定。設定後、再起動。

rootユーザーで実行

- root-boot.sh

```bash:
#!/bin/bash
cat <<EOS >>/etc/apt/apt.conf
Acquire::http::Proxy "http://host:port";
Acquire::https::Proxy "http://host:port";
Acquire::ftp::Proxy "http://host:port";
EOS

cat <<EOS >>/etc/environment
https_proxy=http://host:port
http_proxy=http://host:port
ftp_proxy=http://host:port
HTTPS_PROXY=http://host:port
HTTP_PROXY=http://host:port
FTP_PROXY=http://host:port
no_proxy=localhost,127.0.0.1
NO_PROXY=localhost,127.0.0.1
EOS

cat <<EOS >>/etc/profile
export https_proxy=http://host:port
export http_proxy=http://host:port
export ftp_proxy=http://host:port
export HTTPS_PROXY=http://host:port
export HTTP_PROXY=http://host:port
export FTP_PROXY=http://host:port
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
EOS

cat <<EOS >>/root/.bash_profile
export https_proxy=http://host:port
export http_proxy=http://host:port
export ftp_proxy=http://host:port
export HTTPS_PROXY=http://host:port
export HTTP_PROXY=http://host:port
export FTP_PROXY=http://host:port
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
source /root/.bashrc
EOS

cat <<EOS >>/root/.profile
export https_proxy=http://host:port
export http_proxy=http://host:port
export ftp_proxy=http://host:port
export HTTPS_PROXY=http://host:port
export HTTP_PROXY=http://host:port
export FTP_PROXY=http://host:port
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
EOS

cat <<EOS >>/root/.bashrc
export https_proxy=http://host:port
export http_proxy=http://host:port
export ftp_proxy=http://host:port
export HTTPS_PROXY=http://host:port
export HTTP_PROXY=http://host:port
export FTP_PROXY=http://host:port
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
EOS

cat <<EOS >>/root/.curlrc
proxy=http://host:port
EOS

#コネクション保持期間を延ばす
#https://askubuntu.com/questions/88731/can-the-update-manager-download-only-a-single-package-at-a-time
cat <<EOS >>/etc/apt/apt.conf.d/75download
Acquire::Queue-Mode "access";
Acquire::http::Dl-Limit "120";
EOS

cat <<EOS >>/root/.bashrc
export LD_LIBRARY_PATH=/usr/local/lib
EOS

source /etc/environment
source /etc/profile
source /root/.bash_profile
source /root/.profile
source /root/.bashrc
```

実行権限付与して実行
```bash
chmod 700 root-boot.sh
./root-boot.sh
```

一般ユーザーで実行
- non-root-boot.sh
```bash
#!/bin/bash

cat <<EOS >>~/.bash_profile
export https_proxy=http://host:port
export http_proxy=http://host:port
export ftp_proxy=http://host:port
export HTTPS_PROXY=http://host:port
export HTTP_PROXY=http://host:port
export FTP_PROXY=http://host:port
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
source ~/.bashrc
EOS

cat <<EOS >>~/.profile
export https_proxy=http://host:port
export http_proxy=http://host:port
export ftp_proxy=http://host:port
export HTTPS_PROXY=http://host:port
export HTTP_PROXY=http://host:port
export FTP_PROXY=http://host:port
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
EOS

cat <<EOS >>~/.bashrc
export https_proxy=http://host:port
export http_proxy=http://host:port
export ftp_proxy=http://host:port
export HTTPS_PROXY=http://host:port
export HTTP_PROXY=http://host:port
export FTP_PROXY=http://host:port
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
EOS

cat <<EOS >>~/.curlrc
proxy=http://host:port
EOS

cat <<EOS >>~/.bashrc
export LD_LIBRARY_PATH=/usr/local/lib
EOS

source ~/.bash_profile
source ~/.profile
source ~/.bashrc
```


実行権限付与して実行
```bash
chmod 700 non-root-boot.sh
./non-root-boot.sh
```

# curlコマンドがうごくことを確認

一般ユーザで実行。標準出力になにか垂れ流されているならOK。

```bash
curl -x http://host:port -L https://www.google.com
```

# パッケージアップデート

```bash
sudo apt-get -o Acquire::https::Proxy="http://host:port" update
```

```bash
sudo -E apt-get update
```

```bash
sudo apt-get update
```

# パッケージアップグレード

```bash
sudo apt-get -o Acquire::https::Proxy="http://host:port" -y upgrade
```

```bash
sudo apt-get -y upgrade
```

# パッケージインストール

```bash
sudo apt-get -o Acquire::https::Proxy="http://host:port" install -y zlib1g-dev
sudo apt-get -o Acquire::https::Proxy="http://host:port" install -y libffi-dev
sudo apt-get -o Acquire::https::Proxy="http://host:port" install -y libssl-dev
sudo apt-get -o Acquire::https::Proxy="http://host:port" install -y gcc make
```
